# SPEC.md  
**GaiaSage 系统规格说明（Specification）**

## 1. 目的与定位

GaiaSage 是一个面向 **地理空间分析（Geospatial Analysis）** 的 AI 协作助手（AI Co-pilot）。  
本规格说明用于明确系统的**功能边界、行为契约、质量标准与验收条件**，作为：

- 实现与重构的权威依据  
- 测试与回归的判定标准  
- AI agent / AI coder 行为的约束基线  

任何实现不得偏离本规格，除非通过明确的变更记录（ADR）。

---

## 2. 系统范围（Scope）

### 2.1 系统覆盖范围（In Scope）
- 地理空间相关问题的理解、澄清与分析规划
- 基于历史或已有数据的地理空间分析方法设计
- Google Earth Engine（GEE）分析代码的生成
- 对分析方案与代码的计算成本进行定性评估
- 明确、可审计的多代理协作流程

### 2.2 系统不覆盖范围（Out of Scope）
- 非地理空间领域的问题
- 任何形式的预测、预报或未来趋势推断
- 未经批准的数据集、模型能力或外部系统
- 隐式状态、隐式记忆或不可审计的副作用

---

## 3. 核心行为契约

### 3.1 领域约束（Domain Constraint）
- 系统 **只处理地理空间分析相关问题**。
- 对非地理空间问题，必须返回约定的固定拒绝响应。
- 拒绝响应的文本内容属于系统契约的一部分，不得随意修改。

### 3.2 能力约束（Capability Constraint）
- 对预测性或当前不支持的分析请求：
  1. 必须通过工具记录该请求
  2. 必须返回约定的能力限制说明
- 不得暗示系统具备未实现或未来可能具备的能力。

---

## 4. 多代理协作规格

系统采用 **多代理架构**，每个代理职责明确，不得越权。

### 4.1 代理角色
- **Guard（守卫）**  
  负责领域与能力边界检查，必要时直接终止流程。
- **Planner（规划）**  
  与用户协作，将高层目标转化为结构化、可执行的分析计划。
- **Coder（编码）**  
  根据已批准的分析计划，生成可执行的 GEE 分析代码，并给出成本估计。
- **Orchestrator（编排器）**  
  负责流程控制与状态管理，必须由确定性的 Python 代码实现。

### 4.2 编排原则
- 工作流状态不得依赖 LLM 的隐式记忆。
- 所有关键决策点必须显式、可测试、可回放。

---

## 5. 输出与数据契约

### 5.1 结构化输出
- 所有用于决策或状态推进的输出必须是结构化数据（如 JSON）。
- 自然语言输出不得直接驱动控制逻辑。

### 5.2 稳定性要求
- 在相同输入与约束条件下，系统应产生语义等价的结果。
- 不确定性必须被隔离在非关键路径。

---

## 6. 测试与验证要求

### 6.1 基本要求
- 所有逻辑相关行为必须可通过自动化测试验证。
- 测试失败视为规格未满足。

### 6.2 验收标准（Definition of Done）
功能或改动被视为完成，必须满足：
- 测试全部通过
- 行为符合本 SPEC 定义的契约
- 未引入未记录的风险或隐式行为

---

## 7. 部署与运行约束

- 系统必须兼容：
  - uv 管理的 Python 环境
  - CI 自动化执行
  - 基于 Vercel 的部署形态
- 任何仅在运行时才成立、但无法在 CI 中验证的假设均不被接受。

---

## 8. 变更管理

- 本规格文件是**权威来源**。
- 对规格的修改必须：
  - 明确记录变更动机
  - 说明影响范围
  - 与实现同步更新

---

**本 SPEC 用于约束系统行为，而非描述实现细节。  
实现应服从规格，而非反之。**
